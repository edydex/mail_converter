name: Build Windows EXE

# Trigger conditions with path filtering
on:
  push:
    branches: [ main ]
    paths:
      - 'main.py'
      - 'core/**'
      - 'gui/**'
      - 'build/**'
      - 'requirements.txt'
      - '.github/workflows/**'
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      reason:
        description: 'Reason for manual build'
        required: false
        default: 'Manual trigger'

# Ensure only one build runs at a time
concurrency:
  group: windows-exe-build
  cancel-in-progress: true

# Permissions needed for creating releases
permissions:
  contents: write
  actions: read

jobs:
  build-windows-exe:
    name: Build Windows EXE
    runs-on: windows-latest
    
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 1

    - name: Set up Python 3.11
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: 'pip'

    - name: Install Python Dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pyinstaller
        echo "Python dependencies installed"

    - name: Display Build Environment
      run: |
        echo "Build Environment Information:"
        echo "Python version: $(python --version)"
        echo "Pip version: $(pip --version)"
        echo "Working directory: $(pwd)"
        if ("${{ github.event.inputs.reason }}" -ne "") {
          echo "Manual build reason: ${{ github.event.inputs.reason }}"
        }

    - name: Set up MSYS2
      uses: msys2/setup-msys2@v2
      with:
        msystem: MINGW64
        update: false
        install: >-
          mingw-w64-x86_64-libpst
          mingw-w64-x86_64-pango
          mingw-w64-x86_64-glib2

    - name: Copy MSYS2 binaries and dependencies
      shell: msys2 {0}
      run: |
        echo "Copying readpst.exe and Pango libraries for WeasyPrint..."
        mkdir -p build/bin
        mkdir -p build/gtk
        
        # Copy readpst and libpst
        cp /mingw64/bin/readpst.exe build/bin/
        cp /mingw64/bin/libpst-4.dll build/bin/
        
        # Copy all DLL dependencies for readpst
        for dll in $(ldd /mingw64/bin/readpst.exe | grep mingw64 | awk '{print $3}'); do
          if [ -f "$dll" ]; then
            cp "$dll" build/bin/
            echo "Copied to bin: $(basename $dll)"
          fi
        done
        
        # Copy Pango and dependencies for WeasyPrint (to gtk folder)
        # WeasyPrint uses WEASYPRINT_DLL_DIRECTORIES to find these
        echo ""
        echo "Copying Pango libraries for WeasyPrint..."
        
        # Start with Pango core libs
        for dll in /mingw64/bin/libpango*.dll \
                   /mingw64/bin/libgobject-2.0-0.dll \
                   /mingw64/bin/libglib-2.0-0.dll \
                   /mingw64/bin/libgio-2.0-0.dll \
                   /mingw64/bin/libfontconfig-1.dll \
                   /mingw64/bin/libfreetype-6.dll \
                   /mingw64/bin/libharfbuzz-0.dll \
                   /mingw64/bin/libfribidi-0.dll \
                   /mingw64/bin/libcairo-2.dll \
                   /mingw64/bin/libcairo-gobject-2.dll; do
          if [ -f "$dll" ]; then
            cp "$dll" build/gtk/
            echo "Copied: $(basename $dll)"
          fi
        done
        
        # Recursively copy ALL dependencies
        echo ""
        echo "Copying dependencies..."
        for i in 1 2 3; do  # Multiple passes to get nested deps
          for dll in build/gtk/*.dll; do
            for dep in $(ldd "$dll" 2>/dev/null | grep mingw64 | awk '{print $3}'); do
              if [ -f "$dep" ] && [ ! -f "build/gtk/$(basename $dep)" ]; then
                cp "$dep" build/gtk/
                echo "Copied dependency: $(basename $dep)"
              fi
            done
          done
        done
        
        echo ""
        echo "=== Files in build/bin: ==="
        ls -la build/bin/
        echo ""
        echo "=== Files in build/gtk ($(ls build/gtk/*.dll 2>/dev/null | wc -l) DLLs): ==="
        ls build/gtk/

    - name: Download Poppler for Windows
      run: |
        echo "Downloading Poppler for PDF processing..."
        
        New-Item -ItemType Directory -Force -Path "build/poppler"
        
        $popplerUrl = "https://github.com/oschwartz10612/poppler-windows/releases/download/v24.08.0-0/Release-24.08.0-0.zip"
        $popplerZip = "poppler.zip"
        
        try {
          Invoke-WebRequest -Uri $popplerUrl -OutFile $popplerZip
          Expand-Archive -Path $popplerZip -DestinationPath "build/poppler" -Force
          echo "[OK] Poppler downloaded and extracted"
          
          # List contents to verify
          Get-ChildItem "build/poppler" -Recurse | Select-Object -First 10
        }
        catch {
          echo "[WARNING] Failed to download Poppler: $_"
          echo "[WARNING] PDF attachment conversion may not work"
        }
        finally {
          if (Test-Path $popplerZip) { Remove-Item $popplerZip -Force }
        }

    - name: Build Windows Executable
      run: |
        echo "Starting PyInstaller build process..."
        
        # Run PyInstaller from project root with spec file
        python -m PyInstaller mail_converter.spec --clean
        
        echo "Build process completed"

    - name: Package Application
      run: |
        echo "Packaging application..."
        
        # Create distribution directory
        $distDir = "MayosMailConverter_Portable"
        New-Item -ItemType Directory -Force -Path $distDir
        
        # Copy executable and dependencies (PyInstaller outputs to dist/)
        if (Test-Path "dist/MayosMailConverter") {
          Copy-Item -Path "dist/MayosMailConverter/*" -Destination $distDir -Recurse -Force
          echo "[OK] Copied main application from dist/MayosMailConverter"
        } elseif (Test-Path "dist/MayosMailConverter.exe") {
          Copy-Item "dist/MayosMailConverter.exe" "$distDir/"
          echo "[OK] Copied standalone executable"
        } else {
          echo "[ERROR] No build output found!"
          echo "Contents of dist directory:"
          Get-ChildItem -Path "dist" -Recurse -ErrorAction SilentlyContinue
          exit 1
        }
        
        # Copy readpst.exe and DLL (if not already bundled by PyInstaller)
        if (-not (Test-Path "$distDir/readpst.exe")) {
          if (Test-Path "build/bin/readpst.exe") {
            Copy-Item "build/bin/readpst.exe" "$distDir/"
            echo "[OK] Copied readpst.exe"
          }
        }
        if (-not (Test-Path "$distDir/libpst-4.dll")) {
          if (Test-Path "build/bin/libpst-4.dll") {
            Copy-Item "build/bin/libpst-4.dll" "$distDir/"
            echo "[OK] Copied libpst-4.dll"
          }
        }
        
        # Copy poppler binaries (if not already bundled)
        if (-not (Test-Path "$distDir/poppler")) {
          if (Test-Path "build/poppler/poppler-24.08.0/Library/bin") {
            New-Item -ItemType Directory -Force -Path "$distDir/poppler"
            Copy-Item -Path "build/poppler/poppler-24.08.0/Library/bin/*" -Destination "$distDir/poppler/" -Force
            echo "[OK] Copied Poppler binaries"
          }
        }
        
        # Create README using array of lines
        $readmeLines = @(
          "Mayo's Mail Converter - PST to PDF",
          "===================================",
          "",
          "A tool for converting PST email archives to PDF format with attachment handling.",
          "",
          "Usage:",
          "1. Run MayosMailConverter.exe",
          "2. Select a PST file using the Browse button",
          "3. Choose an output directory",
          "4. Click Convert to PDF",
          "",
          "Features:",
          "- Converts emails to PDF format",
          "- Processes and converts attachments",
          "- Supports folder structure preservation",
          "- Optional separator pages between items",
          "",
          "Requirements:",
          "- Windows 10 or later (64-bit)",
          "",
          "License: PolyForm Noncommercial License 1.0.0"
        )
        $readmeLines | Out-File -FilePath "$distDir/README.txt" -Encoding UTF8
        echo "[OK] Created README.txt"
        
        # List final contents
        echo "Package contents:"
        Get-ChildItem $distDir

    - name: Verify Build Output
      run: |
        echo "Verifying build output..."
        
        $exePath = "MayosMailConverter_Portable/MayosMailConverter.exe"
        if (Test-Path $exePath) {
          $exeSize = (Get-Item $exePath).Length
          $exeSizeMB = [math]::Round($exeSize / 1MB, 2)
          echo "[OK] Executable created: MayosMailConverter.exe ($exeSizeMB MB)"
          echo "Build verification completed successfully"
        } else {
          echo "[ERROR] Executable not found!"
          echo "Contents of build directory:"
          Get-ChildItem -Path "build" -Recurse -ErrorAction SilentlyContinue | Select-Object -First 20
          exit 1
        }

    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: MayosMailConverter-Windows-EXE
        path: MayosMailConverter_Portable/
        retention-days: 30
        compression-level: 6

    - name: Create Release (on main branch)
      if: github.ref == 'refs/heads/main' && github.event_name == 'push'
      uses: softprops/action-gh-release@v2
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: "v1.0.${{ github.run_number }}"
        name: "Mayo's Mail Converter v1.0.${{ github.run_number }}"
        body: |
          ## Mayo's Mail Converter - Windows Executable
          
          **Automatically built from commit:** `${{ github.sha }}`
          
          ### What's Included:
          - **MayosMailConverter.exe** - Standalone Windows executable
          - **Built-in readpst** - Includes libpst functionality for PST extraction
          - **Built-in Poppler** - For PDF attachment processing
          - **No installation required** - Portable application
          - **Works on Windows 10/11** - 64-bit systems
          
          ### How to Use:
          1. Download and extract the ZIP file
          2. Run MayosMailConverter.exe directly - no installation needed
          3. Select your PST file and output directory
          4. Click "Convert to PDF"
          
          ### Features:
          - Convert PST emails to PDF format
          - Process and convert attachments
          - Organize by folder structure
          - Optional separator pages
          
          ---
          *Built automatically with GitHub Actions*
        files: |
          MayosMailConverter_Portable/*
        draft: false
        prerelease: false

    - name: Build Summary
      if: always()
      run: |
        echo ""
        echo "==============================================="
        echo "   Windows EXE Build Summary"
        echo "==============================================="
        $exePath = "MayosMailConverter_Portable/MayosMailConverter.exe"
        if (Test-Path $exePath) {
          $exeSize = (Get-Item $exePath).Length
          $exeSizeMB = [math]::Round($exeSize / 1MB, 2)
          echo "Status: SUCCESS"
          echo "Output: MayosMailConverter.exe ($exeSizeMB MB)"
          echo "Artifact: MayosMailConverter-Windows-EXE"
          if ("${{ github.ref }}" -eq "refs/heads/main") {
            echo "Release: v1.0.${{ github.run_number }}"
          }
        } else {
          echo "Status: FAILED"
          echo "Check the build logs above for errors"
        }
        echo "Download: GitHub Actions Artifacts tab"
        echo "==============================================="
